#!/bin/bash

set -e

# ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ ê²°ì •
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# ê°œë°œ ëª¨ë“œ ê°ì§€ - cli/bin êµ¬ì¡°ê°€ ìˆìœ¼ë©´ ê°œë°œ ëª¨ë“œ
if [ -f "$SCRIPT_DIR/../../docker-compose.dev.yaml" ]; then
    # ê°œë°œ ëª¨ë“œ: PROJECT_ROOT/cli/bin/codekiwi êµ¬ì¡°
    PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
    CONFIG_BASE="$PROJECT_ROOT"
else
    # ì„¤ì¹˜ ëª¨ë“œ: ~/.codekiwi/codekiwi êµ¬ì¡° (cli/bin ë””ë ‰í† ë¦¬ ì—†ìŒ)
    PROJECT_ROOT=""
    CONFIG_BASE="$HOME/.codekiwi"
fi

# Load configuration
if [ -f "$CONFIG_BASE/lib/config-loader.sh" ]; then
    source "$CONFIG_BASE/lib/config-loader.sh"
else
    echo "Error: config-loader.sh not found at $CONFIG_BASE/lib/config-loader.sh" >&2
    exit 1
fi

if [ -n "$PROJECT_ROOT" ] && [ -f "$PROJECT_ROOT/$CODEKIWI_COMPOSE_FILE_DEV" ]; then
    # ê°œë°œ ëª¨ë“œ
    INSTALL_DIR="$PROJECT_ROOT"
    INSTANCES_DIR="$PROJECT_ROOT/instances"
else
    # ì„¤ì¹˜ëœ ëª¨ë“œ
    INSTALL_DIR="${CODEKIWI_INSTALL_DIR:-$HOME/.codekiwi}"
    INSTANCES_DIR="$INSTALL_DIR/instances"
fi

COMPOSE_FILE="$INSTALL_DIR/${CODEKIWI_COMPOSE_FILE_PROD:-docker-compose.yaml}"

# ìƒ‰ìƒ ì½”ë“œ
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# í—¬í¼ í•¨ìˆ˜
print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Docker í™•ì¸
check_docker() {
    if ! command -v docker &> /dev/null; then
        print_error "Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        echo "   https://www.docker.com/get-started ì—ì„œ Dockerë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”."
        exit 1
    fi

    if ! docker info &> /dev/null; then
        print_error "Dockerê°€ ì‹¤í–‰ë˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
        echo "   Docker Desktopì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
        exit 1
    fi
}

# ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ í•´ì‹œë¡œ ë³€í™˜ (ì»¨í…Œì´ë„ˆ ì´ë¦„ìš©)
get_project_hash() {
    local dir="$1"
    echo -n "$dir" | md5sum 2>/dev/null | cut -d' ' -f1 | cut -c1-8 || echo -n "$dir" | md5 | cut -c1-8
}

# ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ ì°¾ê¸°
find_available_port() {
    local start_port=$1
    local port=$start_port

    while [ $port -lt $((start_port + 100)) ]; do
        if ! lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1 && ! docker ps --format '{{.Ports}}' | grep -q ":$port->"; then
            echo $port
            return 0
        fi
        port=$((port + 1))
    done

    print_error "ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
    exit 1
}

# ì¸ìŠ¤í„´ìŠ¤ ë””ë ‰í† ë¦¬ ìƒì„±
ensure_instances_dir() {
    mkdir -p "$INSTANCES_DIR"
}

# ìƒíƒœ íŒŒì¼ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
get_state_file() {
    local project_hash="$1"
    echo "$INSTANCES_DIR/${project_hash}.state"
}

# ìƒíƒœ ì €ì¥
save_state() {
    local project_hash="$1"
    local workspace="$2"
    local web_port="$3"
    local container_name="$4"
    local state_file=$(get_state_file "$project_hash")

    cat > "$state_file" <<EOF
WORKSPACE_DIR="$workspace"
WEB_PORT=$web_port
CONTAINER_NAME="$container_name"
STARTED_AT=$(date +%s)
PID=$$
EOF
}

# ìƒíƒœ ë¡œë“œ
load_state() {
    local state_file="$1"
    if [ -f "$state_file" ]; then
        source "$state_file"
        return 0
    fi
    return 1
}

# ìƒíƒœ ì‚­ì œ
clear_state() {
    local state_file="$1"
    rm -f "$state_file"
}

# í”„ë¡œì íŠ¸ê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
is_project_running() {
    local container_name="$1"
    docker ps --format '{{.Names}}' | grep -q "^${container_name}$"
}

# ëª¨ë“  ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
get_all_instances() {
    ensure_instances_dir
    find "$INSTANCES_DIR" -name "*.state" 2>/dev/null || true
}

# ì •ë¦¬ í•¨ìˆ˜ (Ctrl+C ë˜ëŠ” ì¢…ë£Œ ì‹œ í˜¸ì¶œ)
cleanup() {
    echo ""
    print_info "ì¢…ë£Œ ì¤‘..."

    if [ -n "$CONTAINER_NAME" ]; then
        # Docker ëª…ë ¹ì–´ë¡œ ì§ì ‘ ì¤‘ì§€ ë° ì œê±°
        print_info "ì»¨í…Œì´ë„ˆ ì¤‘ì§€: $CONTAINER_NAME"
        docker stop "$CONTAINER_NAME" 2>/dev/null || true
        docker rm "$CONTAINER_NAME" 2>/dev/null || true
    fi

    if [ -n "$STATE_FILE" ]; then
        clear_state "$STATE_FILE"
    fi

    print_success "CodeKiwiê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
    exit 0
}

# ì‹œì‘ ëª…ë ¹ì–´ (í¬ê·¸ë¼ìš´ë“œ ëª¨ë“œ)
cmd_start() {
    local target_dir="$1"

    # ë””ë ‰í† ë¦¬ ê²°ì •
    if [ -z "$target_dir" ]; then
        target_dir="$PWD"
        print_info "í˜„ì¬ ë””ë ‰í† ë¦¬ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤: $target_dir"
    else
        target_dir="${target_dir/#\~/$HOME}"
    fi

    # ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
    target_dir=$(cd "$target_dir" 2>/dev/null && pwd || echo "$target_dir")

    # ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
    if [ ! -d "$target_dir" ]; then
        print_error "ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $target_dir"
        read -p "ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " create_dir
        if [ "$create_dir" = "y" ] || [ "$create_dir" = "Y" ]; then
            mkdir -p "$target_dir"
            print_success "ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í–ˆìŠµë‹ˆë‹¤: $target_dir"
        else
            exit 1
        fi
    fi

    # ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    local install_template="yes"
    if [ -z "$(ls -A "$target_dir" 2>/dev/null)" ]; then
        echo ""
        print_info "ë””ë ‰í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
        read -p "CodeKiwi í…œí”Œë¦¿ì„ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): " answer
        case "$answer" in
            [Nn]|[Nn][Oo])
                install_template="no"
                print_warning "í…œí”Œë¦¿ ì„¤ì¹˜ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
                ;;
            *)
                install_template="yes"
                print_info "í…œí”Œë¦¿ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤."
                ;;
        esac
        echo ""
    fi

    check_docker
    ensure_instances_dir

    # í”„ë¡œì íŠ¸ í•´ì‹œ ìƒì„±
    local project_hash=$(get_project_hash "$target_dir")
    CONTAINER_NAME="${project_hash}"
    STATE_FILE=$(get_state_file "$project_hash")

    # ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
    if is_project_running "$CONTAINER_NAME"; then
        print_error "ì´ í”„ë¡œì íŠ¸ê°€ ì´ë¯¸ ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤: $target_dir"
        if load_state "$STATE_FILE"; then
            echo "ğŸŒ ì ‘ì† ì£¼ì†Œ: http://localhost:${WEB_PORT}"
        fi
        exit 1
    fi

    # ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ ì°¾ê¸°
    local web_port=$(find_available_port ${CODEKIWI_WEB_PORT_DEFAULT:-8080})

    echo ""
    echo "======================================"
    echo "  CodeKiwi ì‹œì‘"
    echo "======================================"
    echo ""
    print_info "ì‘ì—… ë””ë ‰í† ë¦¬: $target_dir"
    print_info "ì›¹ í¬íŠ¸: $web_port"
    echo ""

    # ì¢…ë£Œ ì‹œê·¸ë„ íŠ¸ë© ì„¤ì •
    trap cleanup SIGINT SIGTERM

    # ìƒíƒœ ì €ì¥
    save_state "$project_hash" "$target_dir" "$web_port" "$CONTAINER_NAME"

    # Docker Compose ì‹¤í–‰ (í¬ê·¸ë¼ìš´ë“œ)
    cd "$INSTALL_DIR"

    print_success "ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
    echo ""

    # ê°œë°œ ëª¨ë“œ í™•ì¸ (docker-compose.dev.yamlì´ ìˆìœ¼ë©´ ë¡œì»¬ ë¹Œë“œ)
    if [ -f "$INSTALL_DIR/$CODEKIWI_COMPOSE_FILE_DEV" ]; then
        print_info "ê°œë°œ ëª¨ë“œ: ë¡œì»¬ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
        # ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹œì‘í•œ í›„ ë¡œê·¸ë¥¼ ë”°ë¼ê°
        WORKSPACE_DIR="$target_dir" \
        WEB_PORT="$web_port" \
        CONTAINER_NAME="$CONTAINER_NAME" \
        INSTALL_TEMPLATE="$install_template" \
        docker-compose -f "$CODEKIWI_COMPOSE_FILE_DEV" up -d --build
    else
        # í”„ë¡œë•ì…˜ ëª¨ë“œ: Docker Hub ì´ë¯¸ì§€ ì‚¬ìš©
        WORKSPACE_DIR="$target_dir" \
        WEB_PORT="$web_port" \
        CONTAINER_NAME="$CONTAINER_NAME" \
        INSTALL_TEMPLATE="$install_template" \
        docker-compose up -d
    fi

    echo ""
    print_success "CodeKiwiê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"
    echo ""
    echo "ğŸŒ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†: ${CYAN}http://localhost:${web_port}${NC}"
    echo "ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬: $target_dir"
    echo ""
    print_warning "Ctrl+Cë¥¼ ëˆŒëŸ¬ ì¢…ë£Œí•˜ì„¸ìš”"
    echo ""
    echo "======================================"
    echo ""

    # ë¸Œë¼ìš°ì € ìë™ ì—´ê¸°
    print_info "ë¸Œë¼ìš°ì €ë¥¼ ì—½ë‹ˆë‹¤..."
    local url="http://localhost:${web_port}"

    if command -v open &> /dev/null; then
        # macOS
        open "$url" &
    elif command -v xdg-open &> /dev/null; then
        # Linux
        xdg-open "$url" &
    elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "win32" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
        # Windows native (Git Bash, MinGW, Cygwin)
        cmd.exe /c start "" "$url" &
    elif command -v start &> /dev/null; then
        # Windows (WSL)
        start "$url" &
    else
        # Fallback - Python
        if command -v python3 &> /dev/null; then
            python3 -m webbrowser "$url" &
        elif command -v python &> /dev/null; then
            python -m webbrowser "$url" &
        fi
    fi

    # ë¡œê·¸ ìŠ¤íŠ¸ë¦¬ë° (í¬ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰)
    docker logs -f "$CONTAINER_NAME"
}

# ëª©ë¡ ëª…ë ¹ì–´
cmd_list() {
    ensure_instances_dir

    echo "======================================"
    echo "  ì‹¤í–‰ ì¤‘ì¸ CodeKiwi ì¸ìŠ¤í„´ìŠ¤"
    echo "======================================"
    echo ""

    local count=0
    local instances=$(get_all_instances)

    if [ -z "$instances" ]; then
        print_warning "ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
        echo ""
        echo "ğŸ’¡ ì‹œì‘í•˜ë ¤ë©´: codekiwi <directory>"
        return 0
    fi

    for state_file in $instances; do
        if load_state "$state_file"; then
            if is_project_running "$CONTAINER_NAME"; then
                count=$((count + 1))

                echo -e "${CYAN}[ì¸ìŠ¤í„´ìŠ¤ #$count]${NC}"
                echo "  ğŸ“ ë””ë ‰í† ë¦¬: $WORKSPACE_DIR"
                echo "  ğŸŒ ì›¹: http://localhost:${WEB_PORT}"
                echo "  ğŸ³ ì»¨í…Œì´ë„ˆ: $CONTAINER_NAME"

                if [ -n "$STARTED_AT" ]; then
                    local now=$(date +%s)
                    local diff=$((now - STARTED_AT))
                    local hours=$((diff / 3600))
                    local minutes=$(((diff % 3600) / 60))
                    echo "  â° ì‹¤í–‰ ì‹œê°„: ${hours}ì‹œê°„ ${minutes}ë¶„"
                fi

                echo ""
            else
                # ì‹¤í–‰ë˜ì§€ ì•ŠëŠ” ìƒíƒœ íŒŒì¼ ì •ë¦¬
                clear_state "$state_file"
            fi
        fi
    done

    if [ $count -eq 0 ]; then
        print_warning "ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
    else
        echo "ì´ ${count}ê°œì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
    fi

    echo ""
}

# ê°•ì œ ì¢…ë£Œ ëª…ë ¹ì–´ (ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ê²ƒì„ ì¢…ë£Œ)
cmd_kill() {
    local target="${1:-$PWD}"
    target="${target/#\~/$HOME}"
    target=$(cd "$target" 2>/dev/null && pwd || echo "$target")

    check_docker
    ensure_instances_dir

    local project_hash=$(get_project_hash "$target")
    local container_name="${project_hash}"
    local state_file=$(get_state_file "$project_hash")

    if ! is_project_running "$container_name"; then
        print_warning "ì´ í”„ë¡œì íŠ¸ëŠ” ì‹¤í–‰ë˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤: $target"
        clear_state "$state_file"
        exit 0
    fi

    print_info "CodeKiwi ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê°•ì œ ì¢…ë£Œí•©ë‹ˆë‹¤: $target"

    docker stop "$container_name" 2>/dev/null || true
    docker rm "$container_name" 2>/dev/null || true

    clear_state "$state_file"

    print_success "ì¸ìŠ¤í„´ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
}

# ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ ê°•ì œ ì¢…ë£Œ
cmd_kill_all() {
    check_docker
    ensure_instances_dir

    print_info "ëª¨ë“  CodeKiwi ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤..."

    local count=0
    for state_file in $(get_all_instances); do
        if load_state "$state_file"; then
            if is_project_running "$CONTAINER_NAME"; then
                print_info "ì¢…ë£Œ ì¤‘: $WORKSPACE_DIR"
                docker stop "$CONTAINER_NAME" 2>/dev/null || true
                docker rm "$CONTAINER_NAME" 2>/dev/null || true
                count=$((count + 1))
            fi
            clear_state "$state_file"
        fi
    done

    if [ $count -eq 0 ]; then
        print_warning "ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."
    else
        print_success "$countê°œì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤."
    fi
}

# ì—…ë°ì´íŠ¸ ëª…ë ¹ì–´
cmd_update() {
    print_info "CodeKiwië¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."

    # ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ í™•ì¸
    local instances=$(get_all_instances)
    if [ -n "$instances" ]; then
        print_warning "ì‹¤í–‰ ì¤‘ì¸ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤."
        echo "ì—…ë°ì´íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ê°€ ì¢…ë£Œë©ë‹ˆë‹¤."
        read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " confirm

        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
            echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
            exit 0
        fi

        cmd_kill_all
    fi

    # GitHubì—ì„œ ìµœì‹  íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    local repo_url="${CODEKIWI_REPO_BASE_URL:-https://raw.githubusercontent.com/aardvarkdev1/codekiwi-cli/main}"

    print_info "CLI íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
    curl -fsSL "$repo_url/cli/bin/codekiwi" -o "$INSTALL_DIR/codekiwi"
    chmod +x "$INSTALL_DIR/codekiwi"

    print_info "ì„¤ì • íŒŒì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
    curl -fsSL "$repo_url/config.env" -o "$INSTALL_DIR/config.env"

    print_info "config-loaderë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
    mkdir -p "$INSTALL_DIR/lib"
    curl -fsSL "$repo_url/lib/config-loader.sh" -o "$INSTALL_DIR/lib/config-loader.sh"

    print_info "docker-compose.yamlì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
    curl -fsSL "$repo_url/docker-compose.yaml" -o "$INSTALL_DIR/docker-compose.yaml"

    print_info "Docker ì´ë¯¸ì§€ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
    local image_name="${CODEKIWI_FULL_IMAGE_NAME:-aardvarkdev1/codekiwi-runtime}"
    local image_tag="${CODEKIWI_IMAGE_TAG_DEFAULT:-latest}"
    docker pull "$image_name:$image_tag"

    print_success "ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
}

# ì œê±° ëª…ë ¹ì–´
cmd_uninstall() {
    echo "CodeKiwië¥¼ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
    echo "ì„¤ì¹˜ ë””ë ‰í† ë¦¬ ($INSTALL_DIR)ê°€ ì‚­ì œë©ë‹ˆë‹¤."
    read -p "ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " confirm

    if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
        echo "ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
        exit 0
    fi

    # ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ ì¤‘ì§€
    cmd_kill_all

    # ì„¤ì¹˜ ë””ë ‰í† ë¦¬ ì‚­ì œ
    print_info "ì„¤ì¹˜ íŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤..."
    rm -rf "$INSTALL_DIR"

    # ì‹¬ë³¼ë¦­ ë§í¬ ì‚­ì œ
    if [ -L "/usr/local/bin/codekiwi" ]; then
        sudo rm /usr/local/bin/codekiwi
    fi

    print_success "CodeKiwiê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤."
}

# ë„ì›€ë§
cmd_help() {
    cat << EOF
CodeKiwi - ì›¹ ê¸°ë°˜ ê°œë°œ í™˜ê²½

ì‚¬ìš©ë²•:
  codekiwi [directory]      í˜„ì¬ ë””ë ‰í† ë¦¬ ë˜ëŠ” ì§€ì •í•œ ë””ë ‰í† ë¦¬ë¡œ ì‹œì‘
                            (í¬ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰, Ctrl+Cë¡œ ì¢…ë£Œ)

  codekiwi list             ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ ëª©ë¡
  codekiwi kill [directory] ì§€ì •í•œ ë””ë ‰í† ë¦¬ì˜ ì¸ìŠ¤í„´ìŠ¤ ê°•ì œ ì¢…ë£Œ
  codekiwi kill --all       ëª¨ë“  ì¸ìŠ¤í„´ìŠ¤ ê°•ì œ ì¢…ë£Œ

  codekiwi update           ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
  codekiwi uninstall        CodeKiwi ì œê±°
  codekiwi help             ì´ ë„ì›€ë§ í‘œì‹œ

ì˜ˆì‹œ:
  # ê¸°ë³¸ ì‚¬ìš© (opencode ìŠ¤íƒ€ì¼)
  cd ~/my-project
  codekiwi                  # í˜„ì¬ ë””ë ‰í† ë¦¬ë¡œ ì‹œì‘
                            # í„°ë¯¸ë„ì´ ìœ ì§€ë˜ê³  ë¡œê·¸ ì¶œë ¥
                            # Ctrl+Cë¡œ ì¢…ë£Œ

  # ì—¬ëŸ¬ í”„ë¡œì íŠ¸ ë™ì‹œ ì‹¤í–‰
  # í„°ë¯¸ë„ 1
  cd ~/project-a
  codekiwi

  # í„°ë¯¸ë„ 2
  cd ~/project-b
  codekiwi

  # í„°ë¯¸ë„ 3 (ëª©ë¡ í™•ì¸)
  codekiwi list

  # ë‹¤ë¥¸ í„°ë¯¸ë„ì—ì„œ ê°•ì œ ì¢…ë£Œ
  codekiwi kill ~/project-a

ìì„¸í•œ ì •ë³´:
  https://github.com/aardvarkdev1/codekiwi-cli

EOF
}

# ë©”ì¸ ëª…ë ¹ì–´ ë¼ìš°íŒ…
main() {
    local cmd="${1:-}"
    local arg="${2:-}"

    case "$cmd" in
        list|ls)
            cmd_list
            ;;
        kill)
            if [ "$arg" = "--all" ] || [ "$arg" = "-a" ]; then
                cmd_kill_all
            else
                cmd_kill "$arg"
            fi
            ;;
        update)
            cmd_update
            ;;
        uninstall)
            cmd_uninstall
            ;;
        help|--help|-h)
            cmd_help
            ;;
        "")
            # ì¸ì ì—†ìŒ - í˜„ì¬ ë””ë ‰í† ë¦¬ë¡œ ì‹œì‘
            cmd_start
            ;;
        *)
            # ë””ë ‰í† ë¦¬ ê²½ë¡œë¡œ ê°„ì£¼
            cmd_start "$cmd"
            ;;
    esac
}

main "$@"
